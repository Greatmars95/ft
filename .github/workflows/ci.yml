name: CI/CD Pipeline

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è workflow:
# - –ü—Ä–∏ push –≤ –≤–µ—Ç–∫–∏ main –∏ develop
# - –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ pull request –≤ main
on:
  push:
    branches: [main, develop, claude/**]
  pull_request:
    branches: [main]

jobs:
  # ============================================
  # JOB 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–±–æ—Ä–∫–∞
  # ============================================
  test:
    name: Tests and Build
    runs-on: ubuntu-latest

    steps:
      # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Go
      - name: üîß Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      # –®–∞–≥ 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º protoc (–¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ proto —Ñ–∞–π–ª–æ–≤)
      - name: üî® Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      # –®–∞–≥ 4: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º protoc –ø–ª–∞–≥–∏–Ω—ã –¥–ª—è Go
      - name: üì¶ Install protoc-gen-go plugins
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

      # –®–∞–≥ 5: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Go –∫–æ–¥ –∏–∑ proto —Ñ–∞–π–ª–æ–≤
      - name: üîÑ Generate proto files
        run: |
          protoc \
            --go_out=. \
            --go_opt=paths=source_relative \
            --go-grpc_out=. \
            --go-grpc_opt=paths=source_relative \
            proto/quotes.proto

      # –®–∞–≥ 6: –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è FT
      - name: üì¶ Download FT dependencies
        run: go mod download

      # –®–∞–≥ 7: –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è HT
      - name: üì¶ Download HT dependencies
        working-directory: ./ht
        run: go mod download

      # –®–∞–≥ 8: –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã FT —Å–µ—Ä–≤–∏—Å–∞
      - name: üß™ Run FT tests
        run: go test -v -cover ./...

      # –®–∞–≥ 9: –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã HT —Å–µ—Ä–≤–∏—Å–∞
      - name: üß™ Run HT tests
        working-directory: ./ht
        run: go test -v -cover ./...

      # –®–∞–≥ 10: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ FT
      - name: ‚úÖ Check FT code formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "‚ùå –ö–æ–¥ –Ω–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: gofmt -w ."
            gofmt -l .
            exit 1
          fi
          echo "‚úÖ –ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"

      # –®–∞–≥ 11: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ HT
      - name: ‚úÖ Check HT code formatting
        working-directory: ./ht
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "‚ùå –ö–æ–¥ –Ω–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: gofmt -w ."
            gofmt -l .
            exit 1
          fi
          echo "‚úÖ –ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"

      # –®–∞–≥ 12: –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑—ã
      - name: üê≥ Build Docker images
        run: docker compose build

      # –®–∞–≥ 13: –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
      - name: üöÄ Start services
        run: docker compose up -d

      # –®–∞–≥ 14: –ñ–¥—ë–º, –ø–æ–∫–∞ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—Å—Ç—è—Ç—Å—è
      - name: ‚è≥ Wait for services to be ready
        run: |
          echo "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ HT —Å–µ—Ä–≤–∏—Å–∞..."
          timeout 30 bash -c 'until curl -f http://localhost:8080/quotes 2>/dev/null; do sleep 2; done' || true
          sleep 5

      # –®–∞–≥ 15: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç - –ø—Ä–æ–≤–µ—Ä—è–µ–º /quotes endpoint
      - name: üîç Integration test - Check /quotes endpoint
        run: |
          echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º HTTP endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/quotes)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

          echo "HTTP –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞: $HTTP_CODE"

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Endpoint /quotes —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
          else
            echo "‚ùå Endpoint /quotes –≤–µ—Ä–Ω—É–ª –∫–æ–¥ $HTTP_CODE"
            exit 1
          fi

      # –®–∞–≥ 16: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
      - name: üìã Show logs on failure
        if: failure()
        run: |
          echo "=== FT Logs ==="
          docker compose logs ft
          echo "=== HT Logs ==="
          docker compose logs ht

      # –®–∞–≥ 17: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
      - name: üõë Stop services
        if: always()
        run: docker compose down

  # ============================================
  # JOB 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è main)
  # ============================================
  deploy:
    name: Deploy to Production
    needs: test  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ test –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ
    if: github.ref == 'refs/heads/main'  # –¢–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ç–∫–∏ main
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Deploy notification
        run: |
          echo "================================================"
          echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
          echo "üöÄ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é –Ω–∞ production"
          echo "================================================"
          echo ""
          echo "–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ"
          echo "—Å–ª–µ–¥—É—é—â–∏–π step –∏ –¥–æ–±–∞–≤—å—Ç–µ secrets –≤ GitHub:"
          echo "  - SERVER_HOST: IP –∏–ª–∏ –¥–æ–º–µ–Ω –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞"
          echo "  - SERVER_USER: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è SSH"
          echo "  - SSH_PRIVATE_KEY: –ø—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á"

      # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫ –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã –∫ –∞–≤—Ç–æ–¥–µ–ø–ª–æ—é:
      #
      # - name: üì° Deploy to server
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.SERVER_HOST }}
      #     username: ${{ secrets.SERVER_USER }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     script: |
      #       cd ~/ft
      #       git pull origin main
      #       docker compose down
      #       docker compose up --build -d
      #       echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
