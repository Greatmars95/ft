# ============================================
# Makefile ‚Äî –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make <–∫–æ–º–∞–Ω–¥–∞>
# ============================================

# .PHONY –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —ç—Ç–æ –Ω–µ —Ñ–∞–π–ª—ã, –∞ –∫–æ–º–∞–Ω–¥—ã
.PHONY: help proto build run stop restart logs clean test status

# –¶–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±—Ä–∞—Ç—å make)
.DEFAULT_GOAL := help

# ==========================================
# help ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
# ==========================================
help:
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë     üèõÔ∏è  Quotopia ‚Äî DevOps Playground  ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  make proto      - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è gRPC –∫–æ–¥–∞ –∏–∑ .proto —Ñ–∞–π–ª–æ–≤"
	@echo "  make build      - –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤"
	@echo "  make run        - –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ (build + up)"
	@echo "  make stop       - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤"
	@echo "  make restart    - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤"
	@echo "  make logs       - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
	@echo "  make status     - –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
	@echo "  make test       - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API"
	@echo "  make clean      - –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –æ–±—Ä–∞–∑—ã, volumes"
	@echo ""
	@echo "–ü—Ä–∏–º–µ—Ä—ã:"
	@echo "  make run        # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë"
	@echo "  make logs       # –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏"
	@echo "  make test       # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API"
	@echo "  make stop       # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"

# ==========================================
# proto ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è gRPC –∫–æ–¥–∞
# ==========================================
proto:
	@echo "üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è gRPC –∫–æ–¥–∞ –∏–∑ proto —Ñ–∞–π–ª–æ–≤..."
	@# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è FT
	@mkdir -p ft/gen/quotes
	@protoc --go_out=./ft/gen/quotes --go_opt=paths=source_relative \
	        --go-grpc_out=./ft/gen/quotes --go-grpc_opt=paths=source_relative \
	        proto/quotes.proto
	@# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è Core
	@mkdir -p core/gen/quotes
	@protoc --go_out=./core/gen/quotes --go_opt=paths=source_relative \
	        --go-grpc_out=./core/gen/quotes --go-grpc_opt=paths=source_relative \
	        proto/quotes.proto
	@echo "‚úÖ Proto —Ñ–∞–π–ª—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã"

# ==========================================
# build ‚Äî —Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
# ==========================================
build:
	@echo "üî® –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤..."
	@docker-compose build --no-cache
	@echo "‚úÖ –û–±—Ä–∞–∑—ã —Å–æ–±—Ä–∞–Ω—ã"

# ==========================================
# run ‚Äî –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
# ==========================================
run:
	@echo "üöÄ –ó–∞–ø—É—Å–∫ Quotopia..."
	@docker-compose up --build -d
	@echo ""
	@echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!"
	@echo ""
	@echo "üìç –î–æ—Å—Ç—É–ø–Ω—ã–µ endpoints:"
	@echo "   http://localhost:8080/health"
	@echo "   http://localhost:8080/quotes"
	@echo "   http://localhost:8080/quotes/BTC"
	@echo ""
	@echo "üí° –ö–æ–º–∞–Ω–¥—ã:"
	@echo "   make logs   - —Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏"
	@echo "   make test   - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API"
	@echo "   make stop   - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"

# ==========================================
# stop ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
# ==========================================
stop:
	@echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
	@docker-compose down
	@echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# ==========================================
# restart ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
# ==========================================
restart: stop run

# ==========================================
# logs ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
# ==========================================
logs:
	@echo "üìã –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ (Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞)..."
	@docker-compose logs -f --tail=100

# ==========================================
# status ‚Äî —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
# ==========================================
status:
	@echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
	@docker-compose ps

# ==========================================
# test ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API
# ==========================================
test:
	@echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API..."
	@echo ""
	@echo "1Ô∏è‚É£  Health check:"
	@curl -s http://localhost:8080/health | jq . || echo "‚ùå Health endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
	@echo ""
	@echo "2Ô∏è‚É£  –í—Å–µ –∫–æ—Ç–∏—Ä–æ–≤–∫–∏:"
	@curl -s http://localhost:8080/quotes | jq . || echo "‚ùå Quotes endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
	@echo ""
	@echo "3Ô∏è‚É£  BTC –∫–æ—Ç–∏—Ä–æ–≤–∫–∞:"
	@curl -s http://localhost:8080/quotes/BTC | jq . || echo "‚ùå BTC endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
	@echo ""
	@echo "4Ô∏è‚É£  –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∫–æ—Ç–∏—Ä–æ–≤–∫–∞:"
	@curl -s http://localhost:8080/quotes/DOGE | jq . || echo "‚ùå Error handling –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
	@echo ""
	@echo "‚úÖ –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"

# ==========================================
# clean ‚Äî –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
# ==========================================
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
	@docker-compose down -v --rmi all --remove-orphans
	@rm -rf ft/gen core/gen
	@echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –æ—á–∏—â–µ–Ω"
